{% extends "base.html" %}
{% block title %}Мой портфель — {{ block.super }}{% endblock %}

{% block content %}
<div style="display:flex; gap:24px; align-items:flex-start;">

  {# ===================== Левая колонка: Портфель ===================== #}
  <div style="flex:1 1 auto; min-width:580px;">
    <h1>{{ request.user.get_full_name|default:request.user.username }}</h1>

    {% if request.user.is_authenticated %}
      <img src="{{ request.user.profile.avatar_url }}" alt=""
           style="height:96px;width:96px;border-radius:90%;object-fit:cover;">
    {% endif %}

    <p><strong>Баланс:</strong> {{ request.user.profile.balance }}</p>

    {% if request.user.profile.google_doc_url %}
      <p><a href="{{ request.user.profile.google_doc_url }}" target="_blank" rel="noopener">Мой документ в Google Docs →</a></p>
    {% endif %}

    <table border="1" cellpadding="6" style="width:100%; max-width:740px;">
      <thead>
        <tr>
          <th>Товар</th>
          <th>Кол-во</th>
          <th>Текущая цена</th>
          <th>Стоимость позиции</th>
        </tr>
      </thead>
      <tbody>
        {% if holdings %}
          {% for h in holdings %}
            <tr>
              <td><a href="{{ h.product.get_absolute_url }}">{{ h.product.title }}</a></td>
              <td>{{ h.quantity }}</td>
              <td>{{ h.product.price }}</td>
              <td>{{ h.position_value }}</td>
            </tr>
          {% endfor %}
          <tr>
            <td colspan="3" style="text-align:right;"><strong>Итого по портфелю:</strong></td>
            <td><strong>{{ total_positions }}</strong></td>
          </tr>
        {% else %}
          <tr><td colspan="4" style="text-align:center;">Владений пока нет</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  {# ===================== Правая колонка: Мои товары ===================== #}
  <aside style="width:360px; flex:0 0 360px;">
    <h3 style="margin:0 0 8px;">Мои товары</h3>
    <p style="margin:0 0 12px; color:#666;">
      Создано: {{ my_products|length }}.
      <a href="{% url 'catalog:create' %}">Добавить товар</a>
    </p>

    {% if my_products %}
      <ul style="list-style:none; padding:0; margin:0; display:grid; gap:10px;">
        {% for p in my_products %}
          <li style="display:flex; gap:10px; align-items:center; border:1px solid #ddd; border-radius:10px; padding:8px;">
            <a href="{{ p.get_absolute_url }}" style="display:block">
              {% if p.image %}
                <img src="{{ p.image.url }}" alt="{{ p.title }}"
                     style="width:64px;height:64px;object-fit:cover;border-radius:8px;">
              {% else %}
                <img src="/media/products/product_placeholder.svg" alt="{{ p.title }}"
                     style="width:64px;height:64px;object-fit:cover;border-radius:8px;">
              {% endif %}
            </a>
            <div style="min-width:0;">
              <div style="font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                <a href="{{ p.get_absolute_url }}">{{ p.title }}</a>
              </div>
              <div style="color:#666; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                {{ p.category.name }} • {{ p.price }} мон.
              </div>
              <div style="font-size:12px; margin-top:4px;">
                {% if p.is_approved %}
                  <span style="color:green;">✓ Одобрен</span>
                {% else %}
                  <span style="color:#b45309;">⏳ На модерации</span>
                {% endif %}
              </div>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div style="border:1px dashed #ccc; border-radius:10px; padding:12px; color:#666;">
        Вы ещё не создали ни одного товара.
        <br><a href="{% url 'catalog:create' %}">Создать первый товар →</a>
      </div>
    {% endif %}
  </aside>

</div>
{% endblock %}
