{% extends "base.html" %}
{% block title %}Мой портфель — {{ block.super }}{% endblock %}

{% block content %}
<div class="layout">
  <section class="card">
    <div class="profile-header">
      <div>
        <h1 class="page-title">{{ request.user.get_full_name|default:request.user.username }}</h1>
        <p class="muted">Ваши активы, баланс и история покупок в одном месте.</p>
      </div>
      {% if request.user.is_authenticated %}
        <img src="{{ request.user.profile.avatar_url }}" alt="" class="avatar">
      {% endif %}
    </div>
     <div class="toolbar section">
      <span class="badge">Баланс: {{ request.user.profile.balance }} мон.</span>
      <a href="{% url 'trade:history' %}" class="button button--soft button--sm">История операций</a>
    </div>
   <div class="link-grid">
      {% if request.user.profile.google_doc_url %}
        <a href="{{ request.user.profile.google_doc_url }}" target="_blank" rel="noopener" class="link-pill">
          Мой документ в Google Docs →
        </a>
      {% endif %}
       {% if request.user.profile.resume_url %}
        <a href="{{ request.user.profile.resume_url }}" target="_blank" rel="noopener" class="link-pill link-pill--success">
          Моё резюме →
        </a>
      {% endif %}
     {% if request.user.profile.resume_example %}
        <a href="{{ request.user.profile.resume_example }}" target="_blank" rel="noopener" class="link-pill link-pill--info">
          Пример резюме →
        </a>
      {% endif %}
       {% if request.user.profile.task_url %}
        <a href="{{ request.user.profile.task_url }}" target="_blank" rel="noopener" class="link-pill link-pill--warning">
          Задание!
        </a>
      {% endif %}
         <a href="https://drive.google.com/drive/u/0/folders/13ov5Vr9KNpgRFUimY1o5F1mnTxBxlKvb"
         target="_blank" rel="noopener" class="link-pill link-pill--neutral">
        Инструкции для оформления заявления
      </a>
    </div>
   <div class="table-responsive">
      <table class="table table--striped">
        <thead>
          <tr>
           <th>Иконка</th>
            <th>Товар</th>
            <th>Кол-во</th>
            <th>Текущая цена</th>
            <th>Стоимость позиции</th>
          </tr>
                  </thead>
        <tbody>
          {% if holdings %}
            {% for h in holdings %}
              <tr>
                <td>
                  {% if h.product.image %}
                    <img src="{{ h.product.image.url }}" alt="{{ h.product.title }}" class="table-image">
                  {% else %}
                    <img src="/media/products/product_placeholder.svg" alt="{{ h.product.title }}" class="table-image">
                  {% endif %}
                </td>
                <td>
                  <a href="{{ h.product.get_absolute_url }}" class="product-card__title">{{ h.product.title }}</a>
                  <div class="muted">{{ h.product.category.name }}</div>
                </td>
                <td>{{ h.quantity }}</td>
                <td>{{ h.product.price }} мон.</td>
                <td><strong>{{ h.position_value }} мон.</strong></td>
              </tr>
            {% endfor %}
            <tr>
              <td colspan="4"><strong>Итого по портфелю:</strong></td>
              <td><strong>{{ total_positions }} мон.</strong></td>
            </tr>
          {% else %}
            <tr>
              <td colspan="5">
                {% include "_includes/_empty_state.html" with text="Владений пока нет." %}
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </section>
<aside class="card">
    <div class="card-header">
      <div>
        <h2 class="card-title">Мои товары</h2>
        <p class="muted">Создано: {{ my_products|length }}.</p>
      </div>
      <a href="{% url 'catalog:create' %}" class="button button--primary button--sm">Добавить</a>
    </div>
     {% if my_products %}
    <div class="stack">
        {% for p in my_products %}
        <div class="product-mini">
            <a href="{{ p.get_absolute_url }}">
              {% if p.image %}
                 <img src="{{ p.image.url }}" alt="{{ p.title }}" class="product-mini__image">
              {% else %}
                 <img src="/media/products/product_placeholder.svg" alt="{{ p.title }}" class="product-mini__image">
              {% endif %}
            </a>
        <div class="product-mini__meta">
              <a href="{{ p.get_absolute_url }}" class="product-mini__title">{{ p.title }}</a>
              <span class="product-mini__details">{{ p.category.name }} • {{ p.price }} мон.</span>
              {% if p.is_approved %}
                <span class="status-pill status-pill--success">✓ Одобрен</span>
              {% else %}
                <span class="status-pill">⏳ На модерации</span>
              {% endif %}
            </div>
        </div>
        {% endfor %}
       </div>
    {% else %}
<div class="notice">
        Вы ещё не создали ни одного товара.
        <br><a href="{% url 'catalog:create' %}">Создать первый товар →</a>
      </div>
    {% endif %}
  </aside>
</div>
{% endblock %}